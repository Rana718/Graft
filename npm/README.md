# Graft ORM

A powerful, database-agnostic migration CLI tool built in Go with multi-database support and type-safe code generation for JavaScript/TypeScript.

## âœ¨ Features

- ğŸ—ƒï¸ **Multi-Database Support**: PostgreSQL, MySQL, SQLite
- ğŸ”„ **Migration Management**: Create, apply, and track migrations
- ğŸ”’ **Safe Migration System**: Transaction-based execution with automatic rollback
- ğŸ“¤ **Smart Export System**: Multiple formats (JSON, CSV, SQLite)
- ğŸ”§ **Type-Safe Code Generation**: Generate fully typed JavaScript/TypeScript code
- âš¡ **Blazing Fast**: 2.5x faster than Drizzle, 10x faster than Prisma
- ğŸ¯ **Prisma-like Commands**: Familiar CLI interface
- ğŸ¨ **Enum Support**: Full PostgreSQL ENUM support

## ğŸ“Š Performance

| Operation | Graft | Drizzle | Prisma |
|-----------|-------|---------|--------|
| Insert 1000 Users | **158ms** | 224ms | 230ms |
| Complex Query x500 | **4071ms** | 12500ms | 56322ms |
| Mixed Workload x1000 | **186ms** | 1174ms | 10863ms |
| **TOTAL** | **6947ms** | **17149ms** | **71551ms** |

## ğŸš€ Installation

```bash
npm install -g graft-orm
```

### For Bun Users

Bun blocks postinstall scripts by default. After installation, run:

```bash
bun pm trust graft-orm
```

Or add to your `package.json`:
```json
{
  "trustedDependencies": ["graft-orm"]
}
```

## ğŸ Quick Start

### 1. Initialize Project

```bash
graft init --postgresql  # or --mysql, --sqlite
```

This creates:
```
your-project/
â”œâ”€â”€ graft.config.json
â”œâ”€â”€ .env
â””â”€â”€ db/
    â”œâ”€â”€ schema/
    â”‚   â””â”€â”€ schema.sql
    â””â”€â”€ queries/
        â””â”€â”€ users.sql
```

### 2. Configure Database

```bash
# .env file
DATABASE_URL=postgresql://user:password@localhost:5432/mydb
```

### 3. Define Schema

**db/schema/schema.sql**
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```

### 4. Write Queries

**db/queries/users.sql**
```sql
-- name: GetUser :one
SELECT id, name, email, created_at, updated_at FROM users
WHERE id = $1 LIMIT 1;

-- name: CreateUser :one
INSERT INTO users (name, email)
VALUES ($1, $2)
RETURNING id, name, email, created_at, updated_at;

-- name: ListUsers :many
SELECT id, name, email, created_at, updated_at FROM users
ORDER BY created_at DESC;

-- name: UpdateUser :one
UPDATE users
SET name = $2, email = $3, updated_at = NOW()
WHERE id = $1
RETURNING id, name, email, created_at, updated_at;

-- name: DeleteUser :exec
DELETE FROM users WHERE id = $1;
```

### 5. Create Migration

```bash
graft migrate "create users table"
```

### 6. Apply Migration

```bash
graft apply
```

### 7. Generate Type-Safe Code

```bash
graft gen
```

**Generated Types (graft_gen/index.d.ts)**
```typescript
// Code generated by Graft. DO NOT EDIT.

export interface Users {
  id: number | null;
  name: string;
  email: string;
  created_at: Date;
  updated_at: Date;
}

export interface GetUserResult {
  id: number | null;
  name: string;
  email: string;
  created_at: Date;
  updated_at: Date;
}

export class Queries {
  constructor(db: any);

  getUser(id: number): Promise<GetUserResult | null>;
  createUser(name: string, email: string): Promise<Users | null>;
  listUsers(): Promise<Users[]>;
  updateUser(id: number, name: string, email: string): Promise<Users | null>;
  deleteUser(id: number): Promise<void>;
}

export function New(db: any): Queries;
```

### 8. Use in Your Code

**index.ts**
```typescript
import { Pool } from 'pg';
import { New } from './graft_gen/database';

const DATABASE_URL = process.env.DATABASE_URL || 'postgresql://postgres:postgres@localhost:5432/mydb';

async function main() {
    const pool = new Pool({
        connectionString: DATABASE_URL,
    });
    
    const db = New(pool);
    
    // Create user - fully type-safe!
    const newUser = await db.createUser('Alice', 'alice@example.com');
    console.log('New user:', newUser);
    
    // Get user by ID
    const user = await db.getUser(newUser.id);
    console.log('Found user:', user);
    
    // List all users
    const users = await db.listUsers();
    console.log('All users:', users);
    
    // Update user
    const updated = await db.updateUser(newUser.id, 'Alice Smith', 'alice.smith@example.com');
    console.log('Updated user:', updated);
    
    await pool.end();
}

main().catch((err) => {
    console.error('Error:', err);
    process.exit(1);
});
```

## ğŸ“‹ All Commands

### Project Setup

```bash
# Initialize new project
graft init --postgresql
graft init --mysql
graft init --sqlite
```

### Migrations

```bash
# Create new migration
graft migrate "migration name"

# Create empty migration
graft migrate "custom migration" --empty

# Apply all pending migrations
graft apply

# Apply with force (skip confirmations)
graft apply --force

# Check migration status
graft status
```

### Code Generation

```bash
# Generate type-safe code
graft gen
```

### Schema Management

```bash
# Pull schema from existing database
graft pull

# Pull with backup
graft pull --backup

# Pull to custom file
graft pull --output custom-schema.sql
```

### Database Export

```bash
# Export as JSON (default)
graft export
graft export --json

# Export as CSV
graft export --csv

# Export as SQLite
graft export --sqlite
```

### Database Operations

```bash
# Reset database (destructive!)
graft reset

# Reset with force
graft reset --force

# Execute raw SQL file
graft raw script.sql
```

### Help & Info

```bash
# Show version
graft --version
graft -v

# Show help
graft --help
graft <command> --help
```

## âš™ï¸ Configuration

**graft.config.json**
```json
{
  "version": "2",
  "schema_path": "db/schema/schema.sql",
  "queries": "db/queries/",
  "migrations_path": "db/migrations",
  "export_path": "db/export",
  "database": {
    "provider": "postgresql",
    "url_env": "DATABASE_URL"
  },
  "gen": {
    "js": {
      "enabled": true,
      "out": "graft_gen"
    }
  }
}
```

## ğŸ¨ PostgreSQL ENUM Support

**Schema with ENUMs**
```sql
CREATE TYPE user_role AS ENUM ('admin', 'user', 'guest');

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    role user_role NOT NULL DEFAULT 'user'
);
```

**Query with ENUM**
```sql
-- name: GetUsersByRole :many
SELECT id, name, role FROM users
WHERE role = $1;
```

**Generated TypeScript**
```typescript
export type UserRole = 'admin' | 'user' | 'guest';

export interface Users {
  id: number | null;
  name: string;
  role: UserRole;
}
```

## ğŸ”’ Safe Migrations

Every migration runs in a transaction with automatic rollback on failure:

```bash
$ graft apply
ğŸ“¦ Applying 2 migration(s)...
  [1/2] 20251103_create_users
      âœ… Applied
  [2/2] 20251103_add_email_index
      âœ… Applied
âœ… All migrations applied successfully
```

If a migration fails:
```bash
âŒ Failed at migration: 20251103_bad_migration
   Error: syntax error at or near "INVALID"
   Transaction rolled back. Fix the error and run 'graft apply' again.
```

## ğŸ›¡ï¸ Conflict Detection

Graft automatically detects schema conflicts:

```bash
âš ï¸  Migration conflicts detected:
  - Table 'users' already exists
  - Column 'email' conflicts with existing column

Reset database to resolve conflicts? (y/n): y
Create export before applying? (y/n): y
ğŸ“¦ Creating export...
âœ… Export created successfully
ğŸ”„ Resetting database and applying all migrations...
```

## ğŸ“¤ Export Formats

### JSON Export
```bash
graft export --json
```
```json
{
  "timestamp": "2025-11-03 16:30:00",
  "version": "1.0",
  "tables": {
    "users": [
      {"id": 1, "name": "Alice", "email": "alice@example.com"}
    ]
  }
}
```

### CSV Export
```bash
graft export --csv
```
Creates directory with individual CSV files per table.

### SQLite Export
```bash
graft export --sqlite
```
Creates portable `.db` file.

## ğŸ”§ Programmatic API

```javascript
const graft = require('graft-orm');

// Execute commands
graft.exec('status');
graft.exec('migrate "add users"');
graft.exec('apply');

// Get binary path
const binaryPath = graft.getBinaryPath();
```

## ğŸ“š Examples

Check out complete examples:
- [TypeScript Example](https://github.com/Lumos-Labs-HQ/graftt/tree/main/example/ts)
- [Go Example](https://github.com/Lumos-Labs-HQ/graftt/tree/main/example/go)

## ğŸ› Troubleshooting

### Bun Postinstall Blocked

```bash
bun pm trust graft-orm
```

### Binary Not Found

```bash
npm install -g graft-orm --force
```

### Database Connection Failed

Check your `DATABASE_URL` in `.env` file.

## ğŸ“– Documentation

- [Full Documentation](https://github.com/Lumos-Labs-HQ/graftt)
- [How It Works](https://github.com/Lumos-Labs-HQ/graftt/blob/main/docs/HOW_IT_WORKS.md)
- [Contributing](https://github.com/Lumos-Labs-HQ/graftt/blob/main/docs/CONTRIBUTING.md)

## ğŸ“„ License

MIT License - see [LICENSE](https://github.com/Lumos-Labs-HQ/graftt/blob/main/LICENSE)

---
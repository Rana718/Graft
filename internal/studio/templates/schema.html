<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema Visualization</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'JetBrains Mono', monospace; }
        body { background: #2b2b2b; color: #a9b7c6; overflow: hidden; }
        
        .topbar { 
            height: 48px; 
            background: #3c3f41; 
            border-bottom: 1px solid #232323; 
            display: flex; 
            align-items: center; 
            padding: 0 16px;
            justify-content: space-between;
        }
        .topbar h1 { font-size: 14px; font-weight: 500; color: #a9b7c6; }
        .topbar-right { display: flex; gap: 12px; align-items: center; }
        .stats { font-size: 11px; color: #6897bb; }
        .btn { 
            padding: 6px 14px; 
            border-radius: 4px; 
            border: 1px solid #555; 
            font-size: 11px; 
            cursor: pointer; 
            background: #4c5052;
            color: #a9b7c6;
            transition: all 0.2s;
        }
        .btn:hover { background: #5a5d5f; }
        
        #canvas-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 48px);
            overflow: auto;
            background: 
                repeating-linear-gradient(0deg, transparent, transparent 19px, #3a3a3a 19px, #3a3a3a 20px),
                repeating-linear-gradient(90deg, transparent, transparent 19px, #3a3a3a 19px, #3a3a3a 20px);
            background-size: 20px 20px;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        #tables {
            position: relative;
            z-index: 2;
            min-width: 100%;
            min-height: 100%;
        }
        
        .table-box {
            position: absolute;
            background: #3c3f41;
            border: 2px solid #5a5d5f;
            border-radius: 4px;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            cursor: move;
            transition: box-shadow 0.2s;
        }
        
        .table-box:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.6);
            border-color: #6897bb;
        }
        
        .table-header {
            background: linear-gradient(180deg, #4b4b4b 0%, #3f3f3f 100%);
            padding: 8px 12px;
            border-bottom: 2px solid #5a5d5f;
            font-weight: 600;
            font-size: 12px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: 2px 2px 0 0;
        }
        
        .table-icon {
            font-size: 14px;
        }
        
        .table-body {
            padding: 0;
            background: #3c3f41;
        }
        
        .table-field {
            padding: 6px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2d2d2d;
            font-size: 11px;
            transition: background 0.15s;
        }
        
        .table-field:hover {
            background: #454749;
        }
        
        .table-field:last-child { 
            border-bottom: none; 
            border-radius: 0 0 2px 2px;
        }
        
        .field-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .field-icon {
            font-size: 12px;
            width: 16px;
            text-align: center;
        }
        
        .field-name { 
            color: #a9b7c6; 
            font-weight: 500;
        }
        
        .field-type { 
            color: #6897bb; 
            font-size: 10px;
            font-weight: 400;
        }
        
        .pk-icon { color: #ffc66d; }
        .fk-icon { color: #10b981; }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: calc(100vh - 48px);
            font-size: 13px;
            color: #6897bb;
            gap: 12px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #3a3a3a;
            border-top-color: #6897bb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Connection lines */
        .connection-line {
            stroke: #6897bb;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        
        .connection-label {
            fill: #6897bb;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <h1>üìä Database Schema Visualization</h1>
        <div class="topbar-right">
            <span id="stats" class="stats">Loading...</span>
            <button class="btn" onclick="window.location.reload()">üîÑ Refresh</button>
            <button class="btn" onclick="window.location.href='/'">‚Üê Back to Data</button>
        </div>
    </div>
    
    <div id="canvas-container">
        <svg id="canvas"></svg>
        <div id="tables"></div>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <div>Loading schema...</div>
        </div>
    </div>

    <script>
        let tables = [];
        let edges = [];
        const canvas = document.getElementById('canvas');
        const container = document.getElementById('canvas-container');
        
        // Load schema
        fetch('/api/schema')
            .then(res => res.json())
            .then(data => {
                console.log('Schema loaded:', data);
                
                if (data.success && data.data) {
                    document.getElementById('loading').style.display = 'none';
                    tables = data.data.nodes || [];
                    edges = data.data.edges || [];
                    
                    if (tables.length === 0) {
                        document.getElementById('loading').innerHTML = '<div>‚ö†Ô∏è No tables found in database</div>';
                        document.getElementById('loading').style.display = 'flex';
                        return;
                    }
                    
                    document.getElementById('stats').textContent = 
                        `${tables.length} tables ‚Ä¢ ${edges.length} relationships`;
                    
                    renderTables();
                    setTimeout(drawConnections, 200);
                } else {
                    showError(data.message || 'Failed to load schema');
                }
            })
            .catch(err => {
                showError('Error: ' + err.message);
                console.error('Error:', err);
            });
        
        function showError(msg) {
            document.getElementById('loading').innerHTML = `<div>‚ùå ${msg}</div>`;
            document.getElementById('loading').style.display = 'flex';
        }
        
        function renderTables() {
            const tablesDiv = document.getElementById('tables');
            tablesDiv.innerHTML = '';
            
            tables.forEach(table => {
                const box = document.createElement('div');
                box.className = 'table-box';
                box.id = `table-${table.id}`;
                box.style.left = table.position.x + 'px';
                box.style.top = table.position.y + 'px';
                
                // Header
                const header = document.createElement('div');
                header.className = 'table-header';
                header.innerHTML = `<span class="table-icon">üìã</span>${table.data.label}`;
                box.appendChild(header);
                
                // Body
                const body = document.createElement('div');
                body.className = 'table-body';
                
                if (table.data.columns && table.data.columns.length > 0) {
                    table.data.columns.forEach(col => {
                        const field = document.createElement('div');
                        field.className = 'table-field';
                        
                        let icon = '';
                        let iconClass = '';
                        if (col.isPrimary) {
                            icon = 'üîë';
                            iconClass = 'pk-icon';
                        } else if (col.isForeign) {
                            icon = 'üîó';
                            iconClass = 'fk-icon';
                        } else {
                            icon = '‚Ä¢';
                        }
                        
                        field.innerHTML = `
                            <div class="field-left">
                                <span class="field-icon ${iconClass}">${icon}</span>
                                <span class="field-name">${col.name}</span>
                            </div>
                            <span class="field-type">${col.type}</span>
                        `;
                        
                        body.appendChild(field);
                    });
                } else {
                    body.innerHTML = '<div class="table-field"><div class="field-left">No columns</div></div>';
                }
                
                box.appendChild(body);
                tablesDiv.appendChild(box);
            });
            
            // Set canvas size
            const maxX = Math.max(...tables.map(t => t.position.x)) + 500;
            const maxY = Math.max(...tables.map(t => t.position.y)) + 600;
            canvas.setAttribute('width', Math.max(maxX, container.clientWidth));
            canvas.setAttribute('height', Math.max(maxY, container.clientHeight));
        }
        
        function drawConnections() {
            // Clear existing
            canvas.innerHTML = '';
            
            // Add arrow marker definition
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            defs.innerHTML = `
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#6897bb" />
                </marker>
            `;
            canvas.appendChild(defs);
            
            edges.forEach(edge => {
                const sourceEl = document.getElementById(`table-${edge.source}`);
                const targetEl = document.getElementById(`table-${edge.target}`);
                
                if (!sourceEl || !targetEl) return;
                
                const sourceRect = sourceEl.getBoundingClientRect();
                const targetRect = targetEl.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                // Calculate connection points (right side of source, left side of target)
                const x1 = sourceRect.right - containerRect.left + container.scrollLeft;
                const y1 = sourceRect.top - containerRect.top + container.scrollTop + sourceRect.height / 2;
                const x2 = targetRect.left - containerRect.left + container.scrollLeft;
                const y2 = targetRect.top - containerRect.top + container.scrollTop + targetRect.height / 2;
                
                // Draw line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('class', 'connection-line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                canvas.appendChild(line);
                
                // Draw label
                if (edge.label) {
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('class', 'connection-label');
                    text.setAttribute('x', (x1 + x2) / 2);
                    text.setAttribute('y', (y1 + y2) / 2 - 5);
                    text.textContent = edge.label;
                    canvas.appendChild(text);
                }
            });
        }
        
        // Redraw on scroll/resize
        container.addEventListener('scroll', drawConnections);
        window.addEventListener('resize', () => {
            canvas.setAttribute('width', container.clientWidth);
            canvas.setAttribute('height', container.clientHeight);
            drawConnections();
        });
    </script>
</body>
</html>
